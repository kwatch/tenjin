<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>pyTenjin User's Guide</title>
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
</head>

<body>
  <blockquote>
    <div class="mainbody">
      <div align="left">
        <h1>pyTenjin User's Guide</h1>
      </div>

      <div align="left">
        release: $Release$<br>
        last update: $Date$<br>
      </div>

      <p>Table of Contents:</p>

      <ul>
        <li>
          <a href="#overview">Overview</a>

          <ul>
            <li><a href="#features">Features</a></li>

            <li><a href="#install">Install</a></li>

            <li><a href="#benchmark">Benchmark</a></li>
          </ul>
        </li>

        <li>
          <a href="#basic-examples">Basic Examples</a>

          <ul>
            <li><a href="#render-template">Render Template</a></li>

            <li><a href="#template-syntax">Template Syntax</a></li>

            <li><a href="#source-code">Show Converted Source Code</a></li>

            <li><a href="#layout-template">Layout Template</a></li>

            <li><a href="#context-variables">Context Variables</a></li>

            <li><a href="#template-arguments">Template Arguments</a></li>

            <li><a href="#partial-template">Include Partial Template</a></li>

            <li><a href="#template-short-name">Template Short Name</a></li>

            <li>
              <a href="#template-encoding">Template Encoding</a>

              <ul>
                <li><a href="#template-encoding-py2">Python 2.x</a></li>

                <li><a href="#template-encoding-py3">Python 3.0</a></li>
              </ul>
            </li>

            <li>
              <a href="#helper-functions">Helper Function</a>

              <ul>
                <li><a href="#tenjin-helpers">tenjin.helpers module</a></li>

                <li><a href="#tenjin-helpers-html">tenjin.helpers.html module</a></li>
              </ul>
            </li>

            <li><a href="#planned-changes">Planned Changes in Next Release (1.0.0)</a></li>
          </ul>
        </li>

        <li>
          <a href="#advanced-features">Advanced Features</a>

          <ul>
            <li><a href="#nested-layout-template">Nested Layout Template</a></li>

            <li><a href="#capturing">Capturing</a></li>

            <li><a href="#templace-cache">Template Cache</a></li>

            <li><a href="#fragment-cache">Fragment Cache</a></li>

            <li><a href="#logging">Logging</a></li>

            <li><a href="#google-appengine">Using Tenjin with Google App Engine</a></li>

            <li><a href="#function-names">Specify Function Names of escape() and to_str()</a></li>

            <li>
              <a href="#preprocessing">Preprocessing</a>

              <ul>
                <li><a href="#preprocessing-basics">Basics of Preprocessing</a></li>

                <li><a href="#preprocessing-loop-expantion">Loop Expantion</a></li>

                <li><a href="#preprocessing-parameters">Parameters</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li>
          <a href="#command"><code>pytenjin</code> Command</a>

          <ul>
            <li><a href="#command-syntax-check">Syntax Check</a></li>

            <li><a href="#command-convert-script">Convert Template into Python Script</a></li>

            <li><a href="#command-retrieve">Retrieve Embedded Code</a></li>

            <li><a href="#command-execute-template">Execute Template File</a></li>

            <li><a href="#command-context-data">Context Data</a></li>
          </ul>
        </li>

        <li>
          <a href="#shooting">Trouble shooting</a>

          <ul>
            <li><a href="#syntax-error">I got an SyntaxError exception.</a></li>

            <li><a href="#encoding-syntaxerr">I got 'SyntaxError: encoding declaration in Unicode string'</a></li>

            <li><a href="#encoding-unicodedecodeerror">I got UnicodeDecodeError, but I can't find what is wrong</a></li>
          </ul>
        </li>

        <li>
          <a href="#tips">Tips</a>

          <ul>
            <li><a href="#flexible-indentation">Flexible Indentation</a></li>

            <li><a href="#tips-webext">Webext</a></li>

            <li><a href="#tips-m17n">M17N Page</a></li>

            <li><a href="#template-inheritance">Template Inheritance</a></li>
          </ul>
        </li>
      </ul><a name="overview" id="overview"></a>

      <h2 class="section1">Overview</h2>

      <p>Tenjin is a very fast and full-featured template engine implemented in pure Python.</p>

      <p>ATTENTION: pyTenjin will change some featrues in next release. See <a href="#planned-changes">Planned Changes in Next Relase</a> section for details.</p><a name="features" id="features"></a>

      <h3 class="section2">Features</h3>

      <ul type="disc">
        <li>
          <a href="#benchmark">Very fast</a>

          <ul type="circle">
            <li>About 10 times faster than Django template</li>

            <li>About 4 times faster than Cheetah</li>

            <li>About 2 times faster than Mako</li>
          </ul>
        </li>

        <li>Full featured

          <ul type="circle">
            <li><a href="#layout-template">Layout template</a></li>

            <li><a href="#partial-template">Partial template</a></li>

            <li><a href="#fragment-cache">Fragment cache</a></li>

            <li><a href="#capturing">Capturing</a></li>

            <li><a href="#preprocessing">Preprocessing</a></li>
          </ul>
        </li>

        <li>Easy to learn

          <ul type="circle">
            <li>Because you can embed any Python statements or expression in your template files</li>

            <li>You don't have to study template-specific language</li>
          </ul>
        </li>

        <li>Compact

          <ul type="circle">
            <li>Only 1500 lines of code</li>

            <li>Very ligthweight to load module (important for CGI script and Google App Engine)</li>
          </ul>
        </li>

        <li><a href="#google-appengine">Supports Google App Engine</a></li>
      </ul><br>
      <a name="install" id="install"></a>

      <h3 class="section2">Install</h3>

      <p>pyTenjin supports Python 2.3 or later. Python 3 is also supported.</p>

      <p>You can install Tenjin by easy_install command.</p>
      <pre class="terminal">
$ sudo easy_install Tenjin
</pre>

      <p>Or download Tenjin-X.X.X.tar.gz, extract it, and type 'python setup.py install'.</p>
      <pre class="terminal">
$ wget http://downloads.sourceforge.net/project/tenjin/pytenjin/X.X.X/Tenjin-X.X.X.tar.gz
$ tar xzf Tenjin-X.X.X.tar.gz
$ cd Tenjin-X.X.X/
$ sudo python setup.py install
</pre><br>
      <a name="benchmark" id="benchmark"></a>

      <h3 class="section2">Benchmark</h3>

      <p>Tenjin package contains benchmark program.</p>

      <div class="terminal_caption">
        MacOS X 10.6 Snow Leopard, Intel CoreDuo2 2GHz, Memory 2GB
      </div>
      <pre class="terminal">
$ cd pytenjin-X.X.X/benchmark
$ python -V
Python 2.5.5
$ python bench.py -q -n 10000
*** ntimes=10000
compiling bench_cheetah.tmpl ... Compiling bench_cheetah.tmpl -&gt; bench_cheetah.py (backup bench_cheetah.py.bak)
*** loading context data (file=bench_context.py)...
*** start benchmark
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.8700    0.0000    3.8700    3.8858
tenjin-create                      4.9600    0.5600    5.5200    5.5457
tenjin-str                         2.4900    0.0000    2.4900    2.4967
tenjin-webext                      2.3500    0.0000    2.3500    2.3703
django                            70.5100    0.0500   70.5600   70.8199
django-create                     83.7900    0.3500   84.1400   84.5050
cheetah                           15.6900    0.0200   15.7100   15.7504
cheetah-create                    16.6700    0.0100   16.6800   16.7545
kid                              287.4500    0.2900  287.7400  289.1525
kid-create                       288.6500    0.4800  289.1300  290.7973
genshi                           208.2000    0.2400  208.4400  209.4677
genshi-create                    452.4900    1.5200  454.0100  456.4957
mako                               7.0500    0.0400    7.0900    7.1348
mako-create                        9.7300    0.8100   10.5400   10.5842
mako-nocache                     110.9300    0.6200  111.5500  112.1807
templetor                         47.5300    0.0700   47.6000   47.8334
templetor-create                 362.8200    2.0100  364.8300  367.4523
jinja2                             7.6800    0.0600    7.7400    8.1972
jinja2-create                    120.5900    0.6200  121.2100  122.0719
</pre>

      <p>Versions:</p>

      <ul type="disc">
        <li>Python 2.5.5</li>

        <li>Tenjin 0.9.0</li>

        <li>Django 1.1.0</li>

        <li>Cheetah 2.2.2</li>

        <li>Kid 0.9.6</li>

        <li>Genshi 0.5.1</li>

        <li>Mako 0.2.5</li>

        <li>Templetor (web.py) 0.32</li>

        <li>Jinja2 2.2.1</li>
      </ul>

      <p>This shows the followings.</p>

      <ul type="disc">
        <li>Tenjin is the fastest template engine.</li>

        <li>Cheetah's performance is good.</li>

        <li>Django's performance is not good.</li>

        <li>Kid's performance is worse. It is too slow.</li>

        <li>Genshi's performance is also worse. It is faster than Kid, but slower than others.</li>

        <li>Mako's performance is very good when module caching is enabled.</li>

        <li>Templetor's performance is not good for mod_python and worse for CGI program.</li>

        <li>Jinja's performance is very good if you can cache template object, but sad performance for CGI program.</li>
      </ul><br>
      <br>
      <a name="basic-examples" id="basic-examples"></a>

      <h2 class="section1">Basic Examples</h2>

      <p>This section describes basics of Tenjin.</p><a name="render-template" id="render-template"></a>

      <h3 class="section2">Render Template</h3>

      <p>Notation:</p>

      <dl class="dl1">
        <dt class="dt1">&lt;?py ... ?&gt;</dt>

        <dd class="dd1">Python statements</dd>

        <dt class="dt1">${...}</dt>

        <dd class="dd1">Python expression (with HTML escape)</dd>

        <dt class="dt1">#{...}</dt>

        <dd class="dd1">Python expression (without HTML escape)</dd>
      </dl><a name="test_010/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml: html template
      </div>
      <pre class="program">
&lt;h2&gt;<strong>${title}</strong>&lt;/h2&gt;
&lt;table&gt;
<strong>&lt;?py i = 0 ?&gt;</strong>
<strong>&lt;?py for item in items: ?&gt;</strong>
<strong>&lt;?py     i += 1 ?&gt;</strong>
<strong>&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt; </strong>
  &lt;tr class="<strong>#{klass}</strong>"&gt;
    &lt;td&gt;<strong>${item}</strong>&lt;/td&gt;
  &lt;/tr&gt;
<strong>&lt;?py #endfor ?&gt;</strong>
&lt;/table&gt;
</pre><a name="test_010/main.py"></a>

      <div class="program_caption">
        main.py: main program
      </div>
      <pre class="program">
## import modules and helper functions
<strong>import tenjin</strong>
<strong>from tenjin.helpers import *</strong>

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## cleate engine object
<strong>engine = tenjin.Engine(path=['views'])</strong>

## render template with context data
html = <strong>engine.render('page.pyhtml', context)</strong>
print(html)
</pre><a name="test_010/result.output"></a>

      <div class="terminal_caption">
        result
      </div>
      <pre class="terminal">
$ python main.py
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

</pre>

      <p>Tips: you can check template syntax by 'pytenjin -z'.</p><a name="test_011/result.output"></a>

      <div class="terminal_caption">
        Syntax check of template files
      </div>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> views/*.pyhtml
views/page.pyhtml - ok.
</pre><br>
      <a name="template-syntax" id="template-syntax"></a>

      <h3 class="section2">Template Syntax</h3>

      <p>You can write any Python statements or expression in yor template file, but there are several restrictions.</p>

      <ul type="disc">
        <li><strong>It is strongly recommended to close 'for', 'if', 'while', ... by corresponding '#endfor', '#endif', '#endwhile', and so on.</strong> This restriction is not enabled in current release, but it will be enabled in the next release (1.0).</li>

        <li>Statement should be indented with 4 spaces. (This restriction will be removed in the next release. See <a href="#flexible-indentation">Flexible Indentation</a> section for details.)</li>

        <li>Conditional expression of 'if', 'while', ... should be in a line.</li>

        <li>'#' (comment) after ':' or '#endXXX' are not allowed.</li>
      </ul>

      <div class="program_caption">
        NG examples
      </div>
      <pre class="program">
## NG because 'for' is not closed by '#endfor'
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #end ?&gt;
&lt;/ul&gt;

## NG because indent is 2 spaces
&lt;?py if x &gt; 0: ?&gt;
&lt;?py   if y &gt; 0: ?&gt;
&lt;?py     if z &gt; 0: ?&gt;
&lt;?py     #endif ?&gt;
&lt;?py   #endif ?&gt;
&lt;?py #endif ?&gt;

## NG because conditional expression of 'if' is not in a line
&lt;?py if re.search(r'^\[(\w+)\]',?&gt;
&lt;?py              line, re.M): ?&gt;
&lt;p&gt;matched.&lt;/p&gt;
&lt;?py #endif ?&gt;

## NG because there is a comment after ':' and '#endfor'
&lt;ul&gt;
&lt;?py if item in items:   ## beginning of loop ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor             ## end of loop ?&gt;
&lt;/ul&gt;
</pre>

      <p>You may feel that indent restriction of Tenjin is strong and not convenient. If you feel so, see <a href="#flexible-indentation">Flexible Indentation</a> section.</p><br>
      <a name="source-code" id="source-code"></a>

      <h3 class="section2">Show Converted Source Code</h3>

      <p>pyTenjin converts template files into Python script and executes it. Compiled Python script is saved into cache file automatically. Cache file is saved with Python's marshal format (= bytecode format).</p>

      <div class="terminal_caption">
        Show cached file
      </div>
      <pre class="terminal">
$ ls views/page.pyhtml*
views/page.pyhtml       views/page.pyhtml.cache
$ file views/page.pyhtml.cache
views/page.pyhtml.cache: data
</pre>

      <p>You can get converted script by '<code>pytenjin -s</code>'.</p><a name="test_020/result.output"></a>

      <div class="terminal_caption">
        Show Python code
      </div>
      <pre class="terminal">
$ pytenjin <strong>-s</strong> views/page.pyhtml
_buf = []; _buf.extend(('''&lt;h2&gt;''', escape(to_str(title)), '''&lt;/h2&gt;
&lt;table&gt;\n''', ));
i = 0
for item in items:
    i += 1
    klass = i % 2 and 'odd' or 'even'
    _buf.extend(('''  &lt;tr class="''', to_str(klass), '''"&gt;
    &lt;td&gt;''', escape(to_str(item)), '''&lt;/td&gt;
  &lt;/tr&gt;\n''', ));
#endfor
_buf.extend(('''&lt;/table&gt;\n''', ));
print(''.join(_buf))
</pre>

      <p>If you specify '<code>-sb</code>' instead of '<code>-s</code>', neither preamble (= '<code>_buf = [];</code>') nor postamble (= '<code>print "".join(_buf)</code>') are printed. See <a href="#command-retrieve">Retrieve Embedded Code</a> section for more information.</p>

      <p>Or:</p><a name="test_021/main.py"></a>

      <div class="program_caption">
        How to convert template file into Python script
      </div>
      <pre class="program">
import tenjin
template = tenjin.Template('views/page.pyhtml')
print(template.script)

### or:
## engine = tenjin.Engine()
## print(engine.get_template('page.pyhtml').script)
</pre><br>
      <a name="layout-template" id="layout-template"></a>

      <h3 class="section2">Layout Template</h3>

      <p>Layout template will help you to use common HTML design for all pages.</p><a name="test_030/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>#{_content}</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_030/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## import modules and helper functions
import tenjin
from tenjin.helpers import *

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## cleate engine object
engine = tenjin.Engine(path=['views']<strong>, layout='_layout.pyhtml'</strong>)

## render template with context data
html = engine.render('page.pyhtml', context)
print(html)
</pre><a name="test_030/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;Tenjin Example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

  &lt;/body&gt;
&lt;/html&gt;

</pre>

      <p>You can specify other layout template file with <code>render()</code> method.</p>
      <pre class="program">
## use other layout template file
engine.render('page.pyhtml', context, <strong>layout='_other_layout.pyhtml'</strong>)

## don't use layout template file
engine.render('page.pyhtml', context, <strong>layout=False</strong>)
</pre>

      <p>Tenjin supports nested layout template. See <a href="#nested-layout-template">Nested Layout Template</a> section for details.</p><br>
      <a name="context-variables" id="context-variables"></a>

      <h3 class="section2">Context Variables</h3>

      <p>'<code>_context</code>' variable contains context dictionary which is passed from main program to template file.</p>

      <p>Using '<code>_context</code>' dictionary, you can pass any data from template file to main program and layout template file.</p><a name="test_040/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;<strong>${page_title}</strong>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
#{_content}
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_040/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml: pass page title date from template to layout template
      </div>
      <pre class="program">
<strong>&lt;?py _context['page_title'] = 'Tenjin: Layout Template Example' ?&gt;</strong>
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;table&gt;
&lt;?py i = 0 ?&gt;
&lt;?py for item in items: ?&gt;
&lt;?py     i += 1 ?&gt;
&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt; 
  &lt;tr class="#{klass}"&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
&lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre><a name="test_040/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;<strong>Tenjin: Layout Template Example</strong>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="template-arguments" id="template-arguments"></a>

      <h3 class="section2">Template Arguments</h3>

      <p>It is recommended to declare context variables in your template files for readability reason.</p><a name="test_050/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS title, items ?&gt;</strong>
&lt;?py _context['page_title'] = 'Tenjin: Layout Template Example' ?&gt;
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;table&gt;
&lt;?py i = 0 ?&gt;
&lt;?py for item in items: ?&gt;
&lt;?py     i += 1 ?&gt;
&lt;?py     klass = i % 2 and 'odd' or 'even' ?&gt; 
  &lt;tr class="#{klass}"&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
&lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre><a name="test_050/result.output"></a>

      <div class="terminal_caption">
        Converted Python script
      </div>
      <pre class="terminal">
$ pytenjin -s views/page.pyhtml
_buf = []
<strong>title = _context.get('title'); items = _context.get('items'); </strong>
_context['page_title'] = 'Tenjin: Layout Template Example'
_buf.extend(('''&lt;h2&gt;''', escape(to_str(title)), '''&lt;/h2&gt;
&lt;table&gt;\n''', ));
i = 0
for item in items:
    i += 1
    klass = i % 2 and 'odd' or 'even'
    _buf.extend(('''  &lt;tr class="''', to_str(klass), '''"&gt;
    &lt;td&gt;''', escape(to_str(item)), '''&lt;/td&gt;
  &lt;/tr&gt;\n''', ));
#endfor
_buf.extend(('''&lt;/table&gt;\n''', ));
print(''.join(_buf))
</pre><a name="test_051/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS _content, page_title ?&gt;</strong>
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;<strong>${page_title}</strong>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
#{_content}
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_051/result.output"></a>

      <div class="terminal_caption">
        Converted Python script
      </div>
      <pre class="terminal">
$ pytenjin -s views/_layout.pyhtml
_buf = []
<strong>_content = _context.get('_content'); page_title = _context.get('page_title'); </strong>
_buf.extend(('''&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;''', escape(to_str(page_title)), '''&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
''', to_str(_content), '''
  &lt;/body&gt;
&lt;/html&gt;\n''', ));
print(''.join(_buf))
</pre>

      <p>Tips: If you want to specify default value of context variable, try <code>_context.get('<em>varname</em>', <em>defaultvalue</em>)</code>.</p>
      <pre class="program">
&lt;?py
## if username is not specified, use 'World' as default.
username = <strong>_context.get('username', 'World')</strong>
?&gt;
&lt;p&gt;Hello ${username}&lt;/p&gt;
</pre><br>
      <a name="partial-template" id="partial-template"></a>

      <h3 class="section2">Include Partial Template</h3>

      <p>You can include other template files by <code>include()</code> helper function.</p>

      <dl class="dl1">
        <dt class="dt1">include(<em>template-name</em>, <em>**kwargs</em>)</dt>

        <dd class="dd1">Include other template. <em>template-name</em> can be file name or template short name. <em>kwargs</em> is passed to template as local variables.</dd>
      </dl><a name="test_060/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, page_title ?&gt;
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${page_title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>&lt;?py include('_header.pyhtml', title=page_title) ?&gt;</strong>
#{_content}
<strong>&lt;?py include('_footer.pyhtml') ?&gt;</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_060/views/_header.pyhtml"></a>

      <div class="program_caption">
        views/_header.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS title ?&gt;</strong>
<strong>&lt;div class="header"&gt;</strong>
  <strong>&lt;h1&gt;${title}&lt;/h1&gt;</strong>
<strong>&lt;/div&gt;</strong>
</pre><a name="test_060/views/_footer.pyhtml"></a>

      <div class="program_caption">
        views/_footer.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?py #@ARGS ?&gt;</strong>
<strong>&lt;address&gt;</strong>
  <strong>copyright(c) 2010 kuwata-lab.com all rights reserved</strong>
<strong>&lt;/address&gt;</strong>
</pre><a name="test_060/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;Tenjin: Layout Template Example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
<strong>&lt;div class="header"&gt;</strong>
  <strong>&lt;h1&gt;Tenjin: Layout Template Example&lt;/h1&gt;</strong>
<strong>&lt;/div&gt;</strong>
&lt;h2&gt;Tenjin Example&lt;/h2&gt;
&lt;table&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;lt;AAA&amp;gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="even"&gt;
    &lt;td&gt;B&amp;amp;B&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr class="odd"&gt;
    &lt;td&gt;&amp;quot;CCC&amp;quot;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

<strong>&lt;address&gt;</strong>
  <strong>copyright(c) 2010 kuwata-lab.com all rights reserved</strong>
<strong>&lt;/address&gt;</strong>
  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="template-short-name" id="template-short-name"></a>

      <h3 class="section2">Template Short Name</h3>

      <p>If you specify template postfix, you can use template short name such as '<code>:views/page</code>' instead of '<code>views/page.pyhtml</code>'. Notice that template short name should start with '<code>:</code>'.</p><a name="test_070/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## import modules and helper functions
import tenjin
from tenjin.helpers import *

## context data
context = {
    'title': 'Tenjin Example',
    'items': ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'],
}

## cleate engine object
engine = tenjin.Engine(path=['views'], <strong>postfix='.pyhtml'</strong>, layout=<strong>':_layout'</strong>)

## render template with context data
html = engine.render(<strong>':page'</strong>, context)
print(html)
</pre><a name="test_070/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, page_title ?&gt;
&lt;!DOCTYPE&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    &lt;title&gt;${page_title}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;?py include(<strong>':_header'</strong>) ?&gt;
#{_content}
&lt;?py include(<strong>':_footer'</strong>) ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><br>
      <a name="template-encoding" id="template-encoding"></a>

      <h3 class="section2">Template Encoding</h3>

      <p>If you want to specify encoding name of template file, add magic comment at 1st line in template file.</p>

      <div class="program_caption">
        Magic comment example
      </div>
      <pre class="program">
&lt;?py # -*- coding: utf-8 -*- ?&gt;
&lt;html&gt;
  ...
</pre><a name="template-encoding-py2" id="template-encoding-py2"></a>

      <h4 class="section3">Python 2.x</h4>

      <p>Tenjin provides two approaches for encoding in Python 2.x.</p>

      <dl class="dl2">
        <dt class="dt2">(A) Binary-based approach</dt>

        <dd class="dd2">
          <p>Tenjin handles templates as binary file. For example, text "foo" will be converted into <code>_buf.exnted(('foo', ))</code>. In this approach, unicode object should be encoded into binary(=str) by <code>to_str()</code>.</p>
          <pre class="program">
to_str = tenjin.generate_tostrfunc(<strong>encode</strong>='utf-8')
   # ex. to_str(u'\u65e5\u672c\u8a9e') =&gt; '\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e'
engine = tenjin.Engine()
</pre>

          <p>If you have some troubles about encoding in this approach, add magic comment into your template file.</p>
          <pre class="program">
<strong>&lt;?py # -*- coding: utf-8 -*- ?&gt;</strong>
&lt;h1&gt;Hello&lt;/h1&gt;
</pre>
        </dd>
      </dl>

      <dl class="dl2">
        <dt class="dt2">(B) Unicode-based approach</dt>

        <dd class="dd2">
          <p>You can hanlde templates as unicode string with <code>encoding</code> option for <code>tenjin.Engine()</code>. For example, text "foo" will be converted into <code>_buf.extend((<strong>u</strong>'foo', ))</code>. In this approach, binary(=str) should be decoded into unicode in <code>to_str()</code>.</p>
          <pre class="program">
to_str = tenjin.generate_tostrfunc(<strong>decode</strong>='utf-8')
   # ex. to_str('\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e')  #=&gt; u'\u65e5\u672c\u8a9e'
engine = tenjin.Engine(<strong>encoding</strong>='utf-8')
html = engine.render('index.pyhtml')
if isinstance(html, unicode): html = html.encode('utf-8')
print(html)
</pre>

          <p>You should not add encoding declaration in your templates, or you will get the following error.</p>
          <pre class="program">
SyntaxError: encoding declaration in Unicode string
</pre>
        </dd>
      </dl>

      <p>In Python 2.x, binary-based approach is faster than unicode-based approach. If you don't have any special reason, it is recommend to be with binary-based approach.</p><br>
      <a name="template-encoding-py3" id="template-encoding-py3"></a>

      <h4 class="section3">Python 3.0</h4>

      <p>In Python 3.0, string is treated as unicode object. So Tenjin handles all templates in string base (= unicode base), and bytes data is converted into str by to_str() function. If you don't specify any encoding, Tenjin uses 'utf-8' encoding as default.</p>
      <pre class="program">
to_str = tenjin.generate_tostrfunc('utf-8')  ## decode bytes into unicode
engine = tenjin.Engine(encoding='utf-8')     ## handle template as unicode
</pre><br>
      <br>
      <a name="helper-functions" id="helper-functions"></a>

      <h3 class="section2">Helper Function</h3>

      <p>Tenjin provides some modules for helper functions.</p><a name="tenjin-helpers" id="tenjin-helpers"></a>

      <h4 class="section3">tenjin.helpers module</h4>

      <p>Module <code>tenjin.helpers</code> provides basic helper functions.</p>

      <dl class="dl1">
        <dt class="dt1">to_str(<em>value</em>)</dt>

        <dd class="dd1">
          Converts value into string. <strong>None is converted into empty string instead of "None".</strong> Unicode object is encoded into string with 'utf-8' encoding name. If you want to use other encoding name, use generate_tostr_func().
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import to_str
&gt;&gt;&gt; to_str(123)
'123'
&gt;&gt;&gt; to_str(None)       # None is converted into empty string
''
&gt;&gt;&gt; to_str(u'日本語')  # unicode object is encoded into str
'\xc3\xa6\xc2\x97\xc2\xa5\xc3\xa6\xc2\x9c\xc2\xac\xc3\xa8\xc2\xaa\xc2\x9e'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">escape(<em>str</em>)</dt>

        <dd class="dd1">
          Escape HTML special characters.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import escape
&gt;&gt;&gt; escape('&lt; &gt; &amp; "')
'&amp;lt; &amp;gt; &amp;amp; &amp;quot;'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">generate_tostrfunc(<em>encode</em>=<em>encoding</em>, <em>decode</em>=<em>encoding</em>)</dt>

        <dd class="dd1">
          Generate to_str() function with enoding name.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers import generate_tostrfunc
&gt;&gt;&gt; ## generate to_str() function which encodes unicode into binary(=str).
&gt;&gt;&gt; to_str = generate_tostrfunc(encode='utf-8')
&gt;&gt;&gt; to_str(u'hoge')
'hoge'
&gt;&gt;&gt; ## generate to_str() function which decodes binary(=str) into unicode.
&gt;&gt;&gt; to_str = generate_tostrfunc(decode='utf-8')
&gt;&gt;&gt; to_str('hoge')
u'hoge'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">echo(<em>value</em>)</dt>

        <dd class="dd1">
          Add value string into _buf. This is similar to echo() function of PHP.
          <pre class="program">
## add _content into here
&lt;?py echo(_content) ?&gt;
## this is same as #{...}
#{_content}
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">not_cached(<em>key</em>, <em>lifetime=0</em>)</dt>

        <dd class="dd1">If fragment is expired or not cached, start caching fragment with <em>key</em> and <em>lifetime</em> (seconds), and returns True. If fragment is already cached with <em>key</em>, returns False. See <a href="#fragment-cache">Fragment Cache</a> for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">echo_cached()</dt>

        <dd class="dd1">Echo cached fragment. If caching is started by not_cached, stop and cache it. This function should be used with not_cached(). See <a href="#fragment-cache">Fragment Cache</a> for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">start_capture(<em>name</em>), stop_capture()</dt>

        <dd class="dd1">Start capturing with specified name. See <a href="#capturing">Capturing</a> section for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">captured_as(<em>name</em>)</dt>

        <dd class="dd1">Return True if captured with name. See <a href="#capturing">Capturing</a> section for details.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">_P(<em>value</em>), _p(<em>value</em>)</dt>

        <dd class="dd1">Helper method for preprocessing. See <a href="#preprocessing">Preprocessing</a> section for details.</dd>
      </dl><br>
      <a name="tenjin-helpers-html" id="tenjin-helpers-html"></a>

      <h4 class="section3">tenjin.helpers.html module</h4>

      <p>Module <code>tenjin.helpers.html</code> provides HTML specific helper functions.</p>

      <dl class="dl1">
        <dt class="dt1">escape(<em>str</em>), escape_xml(<em>str</em>)</dt>

        <dd class="dd1">Escapes HTML special characters. Same as <code>tejin.helpers.escape()</code>.</dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">checked(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' checked="checked"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; checked(1+1==2)
' checked="checked"'
&gt;&gt;&gt; checked(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">selected(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' selected="selected"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; selected(1+1==2)
' selected="selected"'
&gt;&gt;&gt; selected(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">disabled(<em>value</em>)</dt>

        <dd class="dd1">
          Returns <code>' disabled="disabled"'</code> if value is true value, else returns empty string.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; disabled(1+1==2)
' disabled="disabled"'
&gt;&gt;&gt; disabled(1+1==3)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">new_cycle(*<em>values</em>)</dt>

        <dd class="dd1">
          Generates cycle object.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; cycle = new_cycle('odd', 'even')
&gt;&gt;&gt; cycle()
'odd'
&gt;&gt;&gt; cycle()
'even'
&gt;&gt;&gt; cycle()
'odd'
&gt;&gt;&gt; cycle()
'even'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">nl2br(<em>str</em>)</dt>

        <dd class="dd1">
          Replaces <code>"\n"</code> into <code>"&lt;br /&gt;\n"</code>.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; nl2br("foo\nbar\nbaz\n")
'foo&lt;br /&gt;\nbar&lt;br /&gt;\nbaz&lt;br /&gt;\n'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">text2html(<em>str</em>)</dt>

        <dd class="dd1">
          (experimental) Escapes xml characters and replace <code>"\n"</code> into <code>"&lt;br /&gt;\n"</code>.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; text2html('&lt;AAA&gt;\nB&amp;B\n"CCC"\n')
'&amp;lt;AAA&amp;gt;&lt;br /&gt;\nB&amp;amp;B&lt;br /&gt;\n&amp;quot;CCC&amp;quot;&lt;br /&gt;\n'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">tagattr(<em>name</em>, <em>expr</em>, <em>value</em>=None, <em>escape</em>=True)</dt>

        <dd class="dd1">
          (experimental) Returns <code>' name="value"'</code> if <em>expr</em> is true value, else <code>''</code> (empty string). If <em>value</em> is not specified, <em>expr</em> is used as value instead.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; tagattr('name', 'account')
' name="account"'
&gt;&gt;&gt; tagattr('name', None)
''
&gt;&gt;&gt; tagattr('checked', True, 'checked')
' checked="checked"'
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">tagattrs(**<em>kwargs</em>)</dt>

        <dd class="dd1">
          (experimental) Builds html tag attribtes.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; tagattrs(klass='main', size=20)
' class="main" size="20"'
&gt;&gt;&gt; tagattrs(klass='', size=0)
''
</pre>
        </dd>
      </dl>

      <dl class="dl1">
        <dt class="dt1">nv(<em>name</em>, <em>value</em>, <em>sep</em>=None, **<em>kwargs</em>)</dt>

        <dd class="dd1">
          (experimental) Builds name and value attributes.
          <pre class="program">
&gt;&gt;&gt; from tenjin.helpers.html import *
&gt;&gt;&gt; nv('rank', 'A')
'name="rank" value="A"'
&gt;&gt;&gt; nv('rank', 'A', '-')
'name="rank" value="A" id="rank-A"'
&gt;&gt;&gt; nv('rank', 'A', '-', checked=True)
'name="rank" value="A" id="rank-A" checked="checked"'
&gt;&gt;&gt; nv('rank', 'A', '-', klass='error', style='color:red')
'name="rank" value="A" id="rank-A" class="error" style="color:red"'
</pre>
        </dd>
      </dl><br>
      <br>
      <a name="planned-changes" id="planned-changes"></a>

      <h3 class="section2">Planned Changes in Next Release (1.0.0)</h3>

      <p>This section describes planned changes in next release (1.0.0).</p>

      <ul type="disc">
        <li><strong>Indentation will be flexible.</strong> In other words, <a href="http://gist.github.com/129297">http://gist.github.com/129297</a> will be the default template class. See <a href="#flexible-indentation">this section</a> for details.</li>
      </ul>

      <ul type="disc">
        <li><strong>'if', 'for', 'while', ... should be closed by corresponding '#endif', '#endfor', '#endwhile', and so on.</strong> This restriction is necessary to allow flexible indentation.</li>
      </ul>

      <ul type="disc">
        <li><strong>(Maybe) '_buf.extend(...)' will be changed to '_extend = _buf.extend; _extend(...)'.</strong> This change will make Tenjin a little faster (about 2 or 3 %). But this may not be introduced because performance gain is very small<sup>(<a href="#fnref:1" name="fnlink:1" id="fnlink:1">*1</a>)</sup>.</li>
      </ul>

      <div class="footnote">
        <dl compact>
          <dt>(<a name="fnref:1" href="#fnlink:1" id="fnref:1">*1</a>)</dt>

          <dd>In Tenjin, string concatenation is not a bottleneck.</dd>
        </dl>
      </div><br>
      <br>
      <a name="advanced-features" id="advanced-features"></a>

      <h2 class="section1">Advanced Features</h2><a name="nested-layout-template" id="nested-layout-template"></a>

      <h3 class="section2">Nested Layout Template</h3>

      <p>It is able to nest several layout template files.</p><a name="test_nested/views/_site_layout.pyhtml"></a>

      <div class="program_caption">
        views/_site_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content ?&gt;
&lt;html&gt;
  &lt;body&gt;
<strong>#{_content}</strong>
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_nested/views/_blog_layout.pyhtml"></a>

      <div class="program_caption">
        views/_blog_layout.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS _content, title ?&gt;
<strong>&lt;?py _context['_layout'] = '_site_layout.pyhtml' ?&gt;</strong>
&lt;h2&gt;${title}&lt;/h2&gt;
&lt;!-- content --&gt;
<strong>#{_content}</strong>
&lt;!-- /content --&gt;
</pre><a name="test_nested/views/blog_post.pyhtml"></a>

      <div class="program_caption">
        views/blog_post.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS post_content ?&gt;
<strong>&lt;?py _context['_layout'] = '_blog_layout.pyhtml' ?&gt;</strong>
&lt;div class="article"&gt;
#{text2html(post_content)}
&lt;/div&gt;
</pre><a name="test_nested/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
from tenjin.helpers.html import text2html
engine = tenjin.Engine(path=['views'])
context = {
    'title': 'Blog Post Test',
    'post_content': "Foo\nBar\nBaz",
}
html = engine.render('blog_post.pyhtml', context)
print(html)
</pre><a name="test_nested/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;html&gt;
  &lt;body&gt;
&lt;h2&gt;Blog Post Test&lt;/h2&gt;
&lt;!-- content --&gt;
&lt;div class="article"&gt;
Foo&lt;br /&gt;
Bar&lt;br /&gt;
Baz
&lt;/div&gt;

&lt;!-- /content --&gt;

  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="capturing" id="capturing"></a>

      <h3 class="section2">Capturing</h3>

      <p>It is able to capture parital of template. It can be poor-man's alternative of Django's template-inheritance.</p><a name="test_capturing/views/blog-post.pyhtml"></a>

      <div class="program_caption">
        views/blog-post.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS blog_post, recent_posts ?&gt;
&lt;h2&gt;#{blog_post['title']}&lt;/h2&gt;
&lt;div class="blog-post"&gt;
#{text2html(blog_post['content'])}
&lt;/div&gt;

<strong>&lt;?py start_capture('sidebar') ?&gt;</strong>
&lt;h3&gt;Recent Posts&lt;/h3&gt;
&lt;ul&gt;
&lt;?py for post in recent_posts: ?&gt; 
  &lt;a href="/blog/#{post['id']}"&gt;${post['title']}&lt;/a&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
<strong>&lt;?py stop_capture() ?&gt;</strong>
</pre><a name="test_capturing/views/_layout.pyhtml"></a>

      <div class="program_caption">
        views/_layout.pyhtml
      </div>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="header-part"&gt;
<strong>&lt;?py if not captured_as('header'): ?&gt;</strong>
      &lt;h1&gt;My Great Blog&lt;/h1&gt;
<strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
    &lt;div id="main-content"&gt;
#{_content}
    &lt;/div&gt;
    &lt;div id="sidebar-part"&gt;
<strong>&lt;?py if not captured_as('sidebar'): ?&gt;</strong>
      &lt;h3&gt;Links&lt;/h3&gt;
      &lt;ul&gt;
        &lt;a href="http://google.com/"&gt;Google&lt;/a&gt;
        &lt;a href="http://yahoo.com/"&gt;Yahoo!&lt;/a&gt;
      &lt;/ul&gt;
<strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre><a name="test_capturing/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
## context data
blog_post = {
  'title': 'Tenjin is Great',
  'content': """
Tenjin has great features.
- Very Fast
- Full Featured
- Easy to Use
"""[1:]
}
recent_posts = [
  {'id': 1, 'title': 'Tenjin is Fast' },
  {'id': 2, 'title': 'Tenjin is Full-Featured' },
  {'id': 3, 'title': 'Tenjin is Easy-to-Use' },
]
context = {
  'blog_post': blog_post,
  'recent_posts': recent_posts,
}

## render template
import tenjin
from tenjin.helpers import *
from tenjin.helpers.html import text2html
engine = tenjin.Engine(path=['views'], layout='_layout.pyhtml')
html = engine.render('blog-post.pyhtml', context)
print(html)
</pre>

      <p>The result shows that captured string (with name 'sidebar') overwrites layout template content.</p><a name="test_capturing/result.output"></a>

      <div class="program_caption">
        Result
      </div>
      <pre class="program">
$ python main.py
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="header-part"&gt;
      &lt;h1&gt;My Great Blog&lt;/h1&gt;
    &lt;/div&gt;
    &lt;div id="main-content"&gt;
&lt;h2&gt;Tenjin is Great&lt;/h2&gt;
&lt;div class="blog-post"&gt;
Tenjin has great features.&lt;br /&gt;
- Very Fast&lt;br /&gt;
- Full Featured&lt;br /&gt;
- Easy to Use&lt;br /&gt;

&lt;/div&gt;


    &lt;/div&gt;
    &lt;div id="sidebar-part"&gt;
<strong>&lt;h3&gt;Recent Posts&lt;/h3&gt;</strong>
<strong>&lt;ul&gt;</strong>
  <strong>&lt;a href="/blog/1"&gt;Tenjin is Fast&lt;/a&gt;</strong>
  <strong>&lt;a href="/blog/2"&gt;Tenjin is Full-Featured&lt;/a&gt;</strong>
  <strong>&lt;a href="/blog/3"&gt;Tenjin is Easy-to-Use&lt;/a&gt;</strong>
<strong>&lt;/ul&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre><br>
      <a name="templace-cache" id="templace-cache"></a>

      <h3 class="section2">Template Cache</h3>

      <p>Tenjin converts template file into Python script and save it as cache file. By default, it is saved as template-filename + '.cache' in bytecode format. You can change this behaviour by setting <code>tenjin.Engine.cache</code> or passing cache object to <code>tenjin.Engine</code> object.</p>

      <p>For example, if you want to cache template object but want not to create '*.cache' file, use <code>tenjin.MemoryCacheStorage</code> object.</p>

      <div class="program_caption">
        example to change template caching
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## change to store template cache into memory instead of file system
<strong>tenjin.Engine.cache = tenjin.MemoryCacheStorage()</strong>
engine = tenjin.Engine()

## or
engine = tenjin.Engine(<strong>cache=tenjin.MemoryCacheStorage()</strong>)
</pre><br>
      <a name="fragment-cache" id="fragment-cache"></a>

      <h3 class="section2">Fragment Cache</h3>

      <p>You can cache a certain part of HTML to improve performance. This is called as Fragment Cache.</p><a name="test_fragmentcache/views/items.pyhtml"></a>

      <div class="program_caption">
        views/items.pyhtml
      </div>
      <pre class="program">
&lt;?py #@ARGS get_items ?&gt;
&lt;div&gt;
<strong>&lt;?py # fragment cache with key ('items/1') and lifetime (60sec) ?&gt;</strong>
<strong>&lt;?py if not_cached('items/1', 60): ?&gt;</strong>
  &lt;ul&gt;
&lt;?py     for item in get_items(): ?&gt;
    &lt;li&gt;${item}&lt;/li&gt;
&lt;?py     #endfor ?&gt;
  &lt;/ul&gt;
<strong>&lt;?py #endif ?&gt;</strong>
<strong>&lt;?py echo_cached() ?&gt;</strong>
&lt;/div&gt;
</pre>

      <p>Tenjin stores fragments caches into memory by default. If you want to change or customize cache storage, see the following example.</p><a name="test_fragmentcache/main.py"></a>

      <div class="program_caption">
        main.py
      </div>
      <pre class="program">
import os, tenjin
from tenjin.helpers import *

## create key-value store object
if not os.path.isdir('cache.d'): os.mkdir('cache.d')
<strong>kv_store = tenjin.FileBaseStore('cache.d')      # file based</strong>

## set key-value store into tenjin.helpers.fagment_cache object
<strong>tenjin.helpers.fragment_cache.store = kv_store</strong>

## context data
## (it is strongly recommended to create function object
##  to provide pull-style context data)
def get_items():   # called only when cache is expired
    return ['AAA', 'BBB', 'CCC']
context = {'get_items': get_items}

## render html
engine = tenjin.Engine(path=['views'])
html = engine.render('items.pyhtml', context)
print(html)
</pre><a name="test_fragmentcache/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ python main.py
&lt;div&gt;
  &lt;ul&gt;
    &lt;li&gt;AAA&lt;/li&gt;
    &lt;li&gt;BBB&lt;/li&gt;
    &lt;li&gt;CCC&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;

</pre>

      <p>You'll find that HTML fragment is cached into cache directory. This cache data will be expired at 60 seconds after.</p><a name="test_fragmentcache/result2.output"></a>
      <pre class="terminal">
$ cat cache.d/items/1
  &lt;ul&gt;
    &lt;li&gt;AAA&lt;/li&gt;
    &lt;li&gt;BBB&lt;/li&gt;
    &lt;li&gt;CCC&lt;/li&gt;
  &lt;/ul&gt;
</pre><br>
      <a name="logging" id="logging"></a>

      <h3 class="section2">Logging</h3>

      <p>If you set logging object to <code>tenjin.logger</code>, Tenjin will report loading template files.</p>

      <p>For example:</p><a name="test_logging/ex-logger.py"></a>

      <div class="program_caption">
        ex-logger.py
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *

## set logging object
<strong>import logging</strong>
<strong>logging.basicConfig(level=logging.INFO)</strong>
<strong>tenjin.logger = logging</strong>

engine = tenjin.Engine()
context = {'name': 'World'}
html = engine.render('example.pyhtml', context)
</pre>

      <p>If you run it first time, Tenjin will report that template object is stored into cache file.</p><a name="test_logging/result1.output"></a>
      <pre class="terminal">
$ python ex-logger.py &gt; /dev/null
INFO:root:[tenjin.MarshalCacheStorage] <strong>store cache (file='/home/user/example.pyhtml.cache')</strong>
</pre>

      <p>And if you run it again, Tenjin will report that template object is loaded from cache file.</p><a name="test_logging/result2.output"></a>
      <pre class="terminal">
$ python ex-logger.py &gt; /dev/null
INFO:root:[tenjin.MarshalCacheStorage] <strong>load cache (file='/home/user/example.pyhtml.cache')</strong>
</pre><br>
      <a name="google-appengine" id="google-appengine"></a>

      <h3 class="section2">Using Tenjin with Google App Engine</h3>

      <p>Tenjin supports Google App Engine. All you have to do is just call <code>tenjin.gae.init()</code>.</p>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>import tenjin.gae; tenjin.gae.init()</strong>

## it is recommended to configure logging
import logging
logging.basicConfig(level=logging.DEBUG)
<strong>tenjin.logger = logging</strong>
</pre>

      <p><code>tenjin.gae.init()</code> do the followings internally.</p>
      <pre class="program">
## change tenjin.Engine to cache template objects into memcache service
## (using CURRENT_VERSION_ID as namespace).
ver = os.environ.get('CURRENT_VERSION_ID').split('.')[0]
Engine.cache = tenjin.gae.GaeMemcacheCacheStorage(namespace=ver)
## change fragment cache store to use memcache service
fragcache = tenjin.helpers.fragment_cache
fragcache.store    = tenjin.gae.aGaeMemcacheStore(namespace=ver)
fragcache.lifetime = 60    #  1 minute
fragcache.prefix   = 'fragment.'
</pre>

      <p>NOTICE: Google App Engine shares memcache in any version. In other words, Google App Engine doesn't allow to separate memcache for each version. This means that <strong>memcache data can be conflict between old and new version application in Google App Engine</strong>. Tenjin avoids this confliction by using version id as namespace.</p><br>
      <a name="function-names" id="function-names"></a>

      <h3 class="section2">Specify Function Names of escape() and to_str()</h3>

      <p>It is able to specify function names of <code>escape()</code> and <code>to_str()</code> which are used in converted Python script.</p><a name="test_escape/main.py"></a>

      <div class="program_caption">
        main.y
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
engine = tenjin.Engine(path=['views'], <strong>escapefunc='cgi.escape', tostrfunc='str'</strong>)
print(engine.get_template('page.pyhtml').script)
</pre><a name="test_escape/views/page.pyhtml"></a>

      <div class="program_caption">
        views/page.pyhtml
      </div>
      <pre class="program">
&lt;p&gt;
  escaped:     ${value}
  not escaped: #{value}
&lt;/p&gt;
</pre><a name="test_escape/result.output"></a>

      <div class="program_caption">
        Result
      </div>
      <pre class="program">
$ python main.py
_buf.extend(('''&lt;p&gt;
  escaped:     ''', <strong>cgi.escape</strong>(<strong>str</strong>(value)), '''
  not escaped: ''', <strong>str</strong>(value), '''
&lt;/p&gt;\n''', ));

</pre>

      <p>If you need faster version of <code>to_str()</code> and <code>escape()</code>, see <a href="#webext">this section</a>.</p><br>
      <a name="preprocessing" id="preprocessing"></a>

      <h3 class="section2">Preprocessing</h3>

      <p>Tenjin supports preprocessing of template. Preprocessing executes some logics when templates are loaded and that logics are not executed when rendering. Preprocessing makes your application much faster.</p><a name="preprocessing-basics" id="preprocessing-basics"></a>

      <h4 class="section3">Basics of Preprocessing</h4>

      <p>Notation of preprocessing:</p>

      <dl class="dl1">
        <dt class="dt1">&lt;?PY ... ?&gt;</dt>

        <dd class="dd1">Preprocessing statement.</dd>

        <dt class="dt1">#{{...}}</dt>

        <dd class="dd1">Preprocessing expression (without HTML escape)</dd>

        <dt class="dt1">${{...}}</dt>

        <dd class="dd1">Preprocessing expression (with HTML escape)</dd>
      </dl>

      <p>The following shows difference between <code>${ <em>...</em> }</code> and <code>${{ <em>...</em> }}</code>.</p><a name="test_preprocessing/views/pp-example1.pyhtml"></a>

      <div class="program_caption">
        views/pp-example1.pyhtml
      </div>
      <pre class="program">
## normal expression
value = <strong>${value}</strong>
## with preprocessing
value = <strong>${{value}}</strong>
</pre><a name="test_preprocessing/pp-example1.py"></a>

      <div class="program_caption">
        pp-example1.py
      </div>
      <pre class="program">
value = 'My Great Example'

## create engine object with preprocessing enabled
import tenjin
from tenjin.helpers import *
engine = tenjin.Engine(path=['views'], <strong>preprocess=True</strong>)

## print Python script code
print("------ converted script ------")
print(engine.get_template('pp-example1.pyhtml').script)

## render html
html = engine.render('pp-example1.pyhtml', {})
print("------ rendered html ------")
print(html)
</pre><a name="test_preprocessing/result1a.output"></a>

      <div class="terminal_caption">
        Result: notice that <code>${{...}}</code> is evaluated at template converting stage.
      </div>
      <pre class="terminal">
$ python pp-example1.py
------ converted script ------
_buf.extend(('''## normal expression
value = ''', <strong>escape(to_str(value))</strong>, '''
## with preprocessing
value = <strong>My Great Example</strong>\n''', ));

------ rendered html ------
## normal expression
value = My Great Example
## with preprocessing
value = My Great Example

</pre>

      <p>You can confirm preprocessed template by '<code>pytenjin -P</code>' command.</p><a name="test_preprocessing/result1b.output"></a>

      <div class="terminal_caption">
        Preprocessed template
      </div>
      <pre class="terminal">
$ pytenjin <strong>-P</strong> -c 'value="My Great Example"' views/pp-example1.pyhtml
## normal expression
value = ${value}
## with preprocessing
value = My Great Example
</pre>

      <p>If you want to see preprocessing script (not preprocessed script), use '<code>pytenjin -sP</code>' command.</p><a name="test_preprocessing/result1c.output"></a>
      <pre class="terminal">
$ pytenjin <strong>-sP</strong> -c 'value="My Great Example"' views/pp-example1.pyhtml
_buf = []; _buf.extend(('''## normal expression
value = ${value}
## with preprocessing
value = ''', escape(to_str(_decode_params(value))), '''\n''', ));
print(''.join(_buf))
</pre><br>
      <a name="preprocessing-loop-expantion" id="preprocessing-loop-expantion"></a>

      <h4 class="section3">Loop Expantion</h4>

      <p>It is possible to evaluate some logics by '<code>&lt;?PY ?&gt;</code>' when convert template into Python script code. For example, you can expand loop in advance to improve performance.</p><a name="test_preprocessing/views/pp-example2.pyhtml"></a>

      <div class="program_caption">
        views/pp-example2.pyhtml
      </div>
      <pre class="program">
<strong>&lt;?PY states = { "CA": "California", ?&gt;</strong>
<strong>&lt;?PY            "NY": "New York", ?&gt;</strong>
<strong>&lt;?PY            "FL": "Florida",  ?&gt;</strong>
<strong>&lt;?PY            "TX": "Texas",  ?&gt;</strong>
<strong>&lt;?PY            "HI": "Hawaii", } ?&gt;</strong>
<strong>&lt;?PY # ?&gt;</strong>
&lt;?py chk = { params['state']: ' selected="selected"' } ?&gt;
<strong>&lt;?PY codes = states.keys() ?&gt;</strong>
<strong>&lt;?PY codes.sort() ?&gt;</strong>
&lt;select name="state"&gt;
  &lt;option value=""&gt;-&lt;/option&gt;
<strong>&lt;?PY for code in codes: ?&gt;</strong>
  &lt;option value="<strong>#{{code}}</strong>"#{chk.get('<strong>#{{code}}</strong>', '')}&gt;<strong>${{states[code]}}</strong>&lt;/option&gt;
<strong>&lt;?PY #endfor ?&gt;</strong>
&lt;/select&gt;
</pre>

      <p>Preprocessed script code shows that loop is expanded in advance. It means that loop is not executed when rendering template.</p><a name="test_preprocessing/result2a.output"></a>

      <div class="terminal_caption">
        Preprocessed template
      </div>
      <pre class="terminal">
$ pytenjin -P views/pp-example2.pyhtml
&lt;?py chk = { params['state']: ' selected="selected"' } ?&gt;
&lt;select name="state"&gt;
  &lt;option value=""&gt;-&lt;/option&gt;
  &lt;option value="CA"#{chk.get('CA', '')}&gt;California&lt;/option&gt;
  &lt;option value="FL"#{chk.get('FL', '')}&gt;Florida&lt;/option&gt;
  &lt;option value="HI"#{chk.get('HI', '')}&gt;Hawaii&lt;/option&gt;
  &lt;option value="NY"#{chk.get('NY', '')}&gt;New York&lt;/option&gt;
  &lt;option value="TX"#{chk.get('TX', '')}&gt;Texas&lt;/option&gt;
&lt;/select&gt;
</pre><br>
      <a name="preprocessing-parameters" id="preprocessing-parameters"></a>

      <h4 class="section3">Parameters</h4>

      <p>Assume that link_to() is a helper method which takes label and url and generate &lt;a&gt;&lt;/a&gt; tag. In this case, label and url can be parameterized by _p("...") and _P("..."). The former is converted into #{...} and the latter converted into ${...} by preprocessor.</p><a name="test_preprocessing/views/pp-example3.pyhtml"></a>

      <div class="program_caption">
        views/pp-example3.pyhtml
      </div>
      <pre class="program">
&lt;?PY ## ex. link_to('Show', '/show/1')  =&gt; &lt;a href="/show/1"&gt;Show&lt;/a&gt; ?&gt;
&lt;?PY def link_to(label, url): ?&gt;
&lt;?PY     import urllib ?&gt;
&lt;?PY     return '&lt;a href="%s"&gt;%s&lt;/a&gt;' % (urllib.quote(url), label) ?&gt;
&lt;?PY # ?&gt;
#{{link_to('Show '+<strong>_P(</strong>'params["name"]'<strong>)</strong>, '/items/show/'+<strong>_p(</strong>'params["id"]'<strong>)</strong>)}}
</pre>

      <p>The following shows that _P('...') and _p('...') are converted into ${...} and #{...} respectively.</p><a name="test_preprocessing/result3a.output"></a>

      <div class="terminal_caption">
        Preprocessed template:
      </div>
      <pre class="terminal">
$ pytenjin -P views/pp-example3.pyhtml
&lt;a href="/items/show/<strong>#{</strong>params["id"]<strong>}</strong>"&gt;Show <strong>${</strong>params["name"]<strong>}</strong>&lt;/a&gt;
</pre>

      <p>There are many web-application framework and they provides helper functions. These helper functions are divided into two groups. link_to() or _() (function for M17N) return the same result when the same arguments are passed. These functions can be expanded by preprocessor. Some functions return the different result even if the same arguments are passed. These functions can't be expaned by preprocessor.</p>

      <p>Preprocessor has the power to make view-layer much faster, but it may make the debugging difficult. You should use it carefully.</p><br>
      <br>
      <br>
      <a name="command" id="command"></a>

      <h2 class="section1"><code>pytenjin</code> Command</h2>

      <p>See '<code>pytenjin -h</code>' for details.</p><a name="command-syntax-check" id="command-syntax-check"></a>

      <h3 class="section2">Syntax Check</h3>

      <p>Command-line option '<code>-z</code>' checks syntax of template files.</p><a name="test_syntax_check/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
 &lt;li&gt;${item}&lt;/li&gt;
&lt;?py   <strong>#endfor</strong> ?&gt;
&lt;/ul&gt;
</pre><a name="test_syntax_check/result.output"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ pytenjin <strong>-z</strong> example.pyhtml
example.pyhtml:4:3: unindent does not match any outer indentation level
  4:   #endfor
       ^
</pre>

      <p>Error message is the same format as gcc compiler or java compiler. Error jump in Emacs or other editor is available.</p>

      <p>Command-line option '-q' (quiet-mode) prints nothing if it has no errors.</p><br>
      <a name="command-convert-script" id="command-convert-script"></a>

      <h3 class="section2">Convert Template into Python Script</h3>

      <p>Command-line option '-s' converts template file into Python script code.</p><a name="test_convert/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_convert/result1.output"></a>

      <div class="terminal_caption">
        Result (-s)
      </div>
      <pre class="terminal">
$ pytenjin <strong>-s</strong> example.pyhtml
_buf = []; _buf.extend(('''&lt;ul&gt;\n''', ));
for item in items:
    _buf.extend(('''  &lt;li&gt;''', escape(to_str(item)), '''&lt;/li&gt;\n''', ));
#endfor
_buf.extend(('''&lt;/ul&gt;\n''', ));
print(''.join(_buf))
</pre>

      <p>Option '-b' removes preamble ('_buf = []') and postamble ('print "".join(_buf)').</p><a name="test_convert/result2.output"></a>

      <div class="terminal_caption">
        Result (-sb)
      </div>
      <pre class="terminal">
$ pytenjin -s<strong>b</strong> example.pyhtml
_buf.extend(('''&lt;ul&gt;\n''', ));
for item in items:
    _buf.extend(('''  &lt;li&gt;''', escape(to_str(item)), '''&lt;/li&gt;\n''', ));
#endfor
_buf.extend(('''&lt;/ul&gt;\n''', ));
</pre><br>
      <a name="command-retrieve" id="command-retrieve"></a>

      <h3 class="section2">Retrieve Embedded Code</h3>

      <p>Tenjin allows you to retrieve embedded code from template files. This is aimed to help debugging template.</p>

      <p>It is hard to debug large template files because HTML and embedded code are mixed in a file. Retrieving embedded code from template files will help you to debug large template files.</p>

      <p>Assume the following template file.</p><a name="test_retrieve/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;table&gt;
&lt;?py i = 0 ?&gt;
&lt;?py for item in items: ?&gt;
&lt;?py     i += 1 ?&gt;
  &lt;tr&gt;
    &lt;td&gt;#{i}&lt;/td&gt;
    &lt;td&gt;${item}&lt;/td&gt;
  &lt;/tr&gt;
&lt;?py #endfor ?&gt;
&lt;/table&gt;
</pre>

      <p>Option '-S' (or '-a retrieve') retrieves embedded codes.</p><a name="test_retrieve/result1.output"></a>

      <div class="terminal_caption">
        Result (-Sb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>S</strong>b example.pyhtml

i = 0
for item in items:
    i += 1

        to_str(i); 
        escape(to_str(item)); 

#endfor

</pre>

      <p>Option '-X' (or '-a statements') retrieves only statements.</p><a name="test_retrieve/result2.output"></a>

      <div class="terminal_caption">
        Result (-Xb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>X</strong>b example.pyhtml

i = 0
for item in items:
    i += 1




#endfor

</pre>

      <p>Option '-N' adds line numbers.</p><a name="test_retrieve/result3.output"></a>

      <div class="terminal_caption">
        Result (-NXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>N</strong>Xb example.pyhtml
    1:  
    2:  i = 0
    3:  for item in items:
    4:      i += 1
    5:  
    6:  
    7:  
    8:  
    9:  #endfor
   10:  
</pre>

      <p>Option '-U' (unique) compress empty lines.</p><a name="test_retrieve/result4.output"></a>

      <div class="terminal_caption">
        Result (-UNXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>U</strong>NXb example.pyhtml

    2:  i = 0
    3:  for item in items:
    4:      i += 1

    9:  #endfor

</pre>

      <p>Option '-C' (compact) removes empty lines.</p><a name="test_retrieve/result5.output"></a>

      <div class="terminal_caption">
        Result (-CNXb)
      </div>
      <pre class="terminal">
$ pytenjin -<strong>C</strong>NXb example.pyhtml
    2:  i = 0
    3:  for item in items:
    4:      i += 1
    9:  #endfor
</pre><br>
      <a name="command-execute-template" id="command-execute-template"></a>

      <h3 class="section2">Execute Template File</h3>

      <p>You can execute template file in command-line.</p><a name="test_execute/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;?py items = ['&lt;AAA&gt;', 'B&amp;B', '"CCC"'] ?&gt;
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_execute/result.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin example.pyhtml
&lt;ul&gt;
  &lt;li&gt;&amp;lt;AAA&amp;gt;&lt;/li&gt;
  &lt;li&gt;B&amp;amp;B&lt;/li&gt;
  &lt;li&gt;&amp;quot;CCC&amp;quot;&lt;/li&gt;
&lt;/ul&gt;
</pre><br>
      <a name="command-context-data" id="command-context-data"></a>

      <h3 class="section2">Context Data</h3>

      <p>You can specify context data with command-line option '<code>-c</code>'.</p><a name="test_context/example.pyhtml"></a>

      <div class="program_caption">
        example.pyhtml
      </div>
      <pre class="program">
&lt;ul&gt;
&lt;?py for item in items: ?&gt;
  &lt;li&gt;${item}&lt;/li&gt;
&lt;?py #endfor ?&gt;
&lt;/ul&gt;
</pre><a name="test_context/result1.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-c 'items=["A","B","C"]'</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;A&lt;/li&gt;
  &lt;li&gt;B&lt;/li&gt;
  &lt;li&gt;C&lt;/li&gt;
&lt;/ul&gt;
</pre>

      <p>If you want to specify several values, separate them by ';' such as '-c "x=10; y=20"'.</p>

      <p>If you installed PyYAML library, you can specify context data in YAML format. Tenjin regards context data string as YAML format if it starts with '{'.</p><a name="test_context/result2.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-c '{items: [A, B, C]}'</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;A&lt;/li&gt;
  &lt;li&gt;B&lt;/li&gt;
  &lt;li&gt;C&lt;/li&gt;
&lt;/ul&gt;
</pre>

      <p>In addition, Tenjin supports context data file in Python format or YAML format.</p><a name="test_context/context.py"></a>

      <div class="program_caption">
        context.py
      </div>
      <pre class="program">
items = [
   "AAA",
   123,
   True,
]
</pre><a name="test_context/result3.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-f context.py</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;AAA&lt;/li&gt;
  &lt;li&gt;123&lt;/li&gt;
  &lt;li&gt;True&lt;/li&gt;
&lt;/ul&gt;
</pre><a name="test_context/context.yaml"></a>

      <div class="program_caption">
        context.yaml
      </div>
      <pre class="program">
items:
  - AAA
  - 123
  - true
</pre><a name="test_context/result4.output"></a>

      <div class="terminal_caption">
        Result
      </div>
      <pre class="terminal">
$ pytenjin <strong>-f context.yaml</strong> example.pyhtml
&lt;ul&gt;
  &lt;li&gt;AAA&lt;/li&gt;
  &lt;li&gt;123&lt;/li&gt;
  &lt;li&gt;True&lt;/li&gt;
&lt;/ul&gt;
</pre><br>
      <br>
      <a name="shooting" id="shooting"></a>

      <h2 class="section1">Trouble shooting</h2><a name="syntax-error" id="syntax-error"></a>

      <h3 class="section2">I got an SyntaxError exception.</h3>

      <p>Command-line option '-z' checks syntax of template file. You should check template by it.</p>

      <p>File 'syntaxerr.pyhtml':</p><a name="test_syntaxerr/syntaxerr.pyhtml"></a>
      <pre class="program">
&lt;?py for i in range(0, 10): ?&gt;
&lt;?py     if i % 2 == 0: ?&gt;
#{i} is even.
&lt;?py     else ?&gt;
#{i} is odd.
&lt;?py     #end ?&gt;
&lt;?py #end ?&gt;
</pre>

      <p>Result:</p><a name="test_syntaxerr/result.output"></a>
      <pre class="terminal">
$ pytenjin -z syntaxerr.pyhtml
syntaxerr.pyhtml:4:9: invalid syntax
  4:     else
             ^
</pre><br>
      <a name="encoding-syntaxerr" id="encoding-syntaxerr"></a>

      <h3 class="section2">I got 'SyntaxError: encoding declaration in Unicode string'</h3>

      <p>This is because you added encoding declaration in template file AND you specified encoding option to tenjin.Engine() or tenjin.Template().</p>

      <p>Solution:</p>

      <ul type="disc">
        <li>If you specify encoding option to tenjin.Engine() or tenjin.Template(), remove encoding declaration from your template file.</li>

        <li>If you want to add encoding declaration into your template file, don't specify encoding option to tenjin.Engine() or tenjin.Template().</li>
      </ul><br>
      <a name="encoding-unicodedecodeerror" id="encoding-unicodedecodeerror"></a>

      <h3 class="section2">I got UnicodeDecodeError, but I can't find what is wrong</h3>

      <p>If you got UnicodeDecodeError, you should do the following solutions.</p>

      <ul type="disc">
        <li>Set logger to <code>tenjin.logger</code>. If you set, Tenjin will report the content of <code>_buf</code>.
          <pre class="program">
<strong>import logging</strong>
<strong>logging.basicConfig(level=logging.DEBUG)</strong>
<strong>tenjin.logger = logging</strong>
</pre>
        </li>
      </ul>

      <ul type="disc">
        <li>Render tempalte with specifying <code>_buf</code> and check it directly.
          <pre class="program">
<strong>_buf = []</strong>
try:
    engine.get_template("index.pyhtml").render(context, <strong>_buf=_buf</strong>)
    print(''.join(_buf))
except UnicodeDecodeError:
    for item in _buf:
        if isinstance(item, str):
            try:
                str.decode('ascii')
            except UnicodeDecodeError:
                print("*** failed to decode: %s" % repr(item))
</pre>
        </li>
      </ul><br>
      <br>
      <a name="tips" id="tips"></a>

      <h2 class="section1">Tips</h2><a name="flexible-indentation" id="flexible-indentation"></a>

      <h3 class="section2">Flexible Indentation</h3>

      <p>You may want Tenjin to be more flexible about indentation of statements. For example, You may not like such as:</p>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="main-content"&gt;
<strong>&lt;?py if items: ?&gt;</strong>
      &lt;table&gt;
        &lt;tbody&gt;
    <strong>&lt;?py i = 0 ?&gt;</strong>
    <strong>&lt;?py for item in items: ?&gt;</strong>
    <strong>&lt;?py     i += 1 ?&gt;</strong>
          &lt;tr&gt;
            &lt;td&gt;${i}&lt;/td&gt;
        <strong>&lt;?py if item: ?&gt;</strong>
            &lt;td&gt;${item}&lt;/td&gt;
        <strong>&lt;?py else: ?&gt;</strong>
            &lt;td&gt;-&lt;/td&gt;
        <strong>&lt;?py #endif ?&gt;</strong>
          &lt;/tr&gt;
    <strong>&lt;?py #endfor ?&gt;</strong>
        &lt;/tbody&gt;
      &lt;/table&gt;
<strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

      <p>And you may prefer the following:</p><a name="test_flexibleindent/flexibleindent.pyhtml"></a>

      <div class="program_caption">
        File 'flexibleindent.pyhtml':
      </div>
      <pre class="program">
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="main-content"&gt;
      <strong>&lt;?py if items: ?&gt;</strong>
      &lt;table&gt;
        &lt;tbody&gt;
          <strong>&lt;?py i = 0 ?&gt;</strong>
          <strong>&lt;?py for item in items: ?&gt;</strong>
          <strong>&lt;?py   i += 1 ?&gt;</strong>
          &lt;tr&gt;
            &lt;td&gt;${i}&lt;/td&gt;
            <strong>&lt;?py if item: ?&gt;</strong>
            &lt;td&gt;${item}&lt;/td&gt;
            <strong>&lt;?py else: ?&gt;</strong>
            &lt;td&gt;-&lt;/td&gt;
            <strong>&lt;?py #endif ?&gt;</strong>
          &lt;/tr&gt;
        <strong>&lt;?py #endfor ?&gt;</strong>
        &lt;/tbody&gt;
      &lt;/table&gt;
      <strong>&lt;?py #endif ?&gt;</strong>
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

      <p>If you want Tenjin to be more flexible about indentation, try <a href="http://gist.github.com/129297">http://gist.github.com/129297</a>. Save this code as 'my_template.py' and try the following:</p><a name="test_flexibleindent/flexibleindent.py"></a>

      <div class="program_caption">
        File 'flexibleindent.py':
      </div>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>from my_template import MyTemplate</strong>
<strong>tenjin.Engine.templateclass = MyTemplate</strong>

import sys
template_name = len(sys.argv) &gt; 1 and sys.argv[1] or 'flexibleindent.pyhtml'
engine = tenjin.Engine()
print("-------------------- script")
print(engine.get_template(template_name).script)
print("-------------------- html")
html = engine.render(template_name, {'items': ['AAA', None, 'CCC']})
print(html)
</pre><a name="test_flexibleindent/result.output"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python flexibleindent.py flexibleindent.pyhtml
-------------------- script
_buf.extend(('''&lt;html&gt;
  &lt;body&gt;
    &lt;div id="main-content"&gt;\n''', ));
<strong>if items:</strong>
    _buf.extend(('''      &lt;table&gt;
        &lt;tbody&gt;\n''', ));
    <strong>i = 0</strong>
    <strong>for item in items:</strong>
        <strong>i += 1</strong>
        _buf.extend(('''          &lt;tr&gt;
            &lt;td&gt;''', escape(to_str(i)), '''&lt;/td&gt;\n''', ));
        <strong>if item:</strong>
            _buf.extend(('''            &lt;td&gt;''', escape(to_str(item)), '''&lt;/td&gt;\n''', ));
        <strong>else:</strong>
            _buf.extend(('''            &lt;td&gt;-&lt;/td&gt;\n''', ));
        <strong>#endif</strong>
        _buf.extend(('''          &lt;/tr&gt;\n''', ));
    <strong>#endfor</strong>
    _buf.extend(('''        &lt;/tbody&gt;
      &lt;/table&gt;\n''', ));
<strong>#endif</strong>
_buf.extend(('''    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;\n''', ));

-------------------- html
&lt;html&gt;
  &lt;body&gt;
    &lt;div id="main-content"&gt;
      &lt;table&gt;
        &lt;tbody&gt;
          &lt;tr&gt;
            &lt;td&gt;1&lt;/td&gt;
            &lt;td&gt;AAA&lt;/td&gt;
          &lt;/tr&gt;
          &lt;tr&gt;
            &lt;td&gt;2&lt;/td&gt;
            &lt;td&gt;-&lt;/td&gt;
          &lt;/tr&gt;
          &lt;tr&gt;
            &lt;td&gt;3&lt;/td&gt;
            &lt;td&gt;CCC&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre>

      <p>NOTE: MyTemplate will be the default template class in next release (1.0.0).</p><br>
      <a name="tips-webext" id="tips-webext"></a>

      <h3 class="section2">Webext</h3>

      <p>I have to say that <strong>bottleneck of Tenjin is calling to_str() and escape(), not string concatenation</strong>. Therefore if you want to make Tenjin much faster, you must make to_str() and escape() faster (or omit calling them).</p>

      <p>For example, using <code>str()</code> instead of <code>to_str()</code> will make Tenjin much faster. The following benchmark result shows that <code>str()</code>(= 'tenjin-str') is much faster than <code>to_str()</code>(= 'tenjin').</p>

      <div class="terminal_caption">
        <code>str()</code> is faster than <code>to_str()</code>
      </div>
      <pre class="terminal">
$ cd Tenjin-X.X.X/benchmark
$ python -V
Python 2.5.5
$ python bench.py -q -n 10000 tenjin tenjin-str
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.7500    0.0400    3.7900    3.7936
tenjin-str                         2.4500    0.0300    2.4800    2.4857
</pre>

      <p>But <code>str()</code> doesn't return empty string if argument is <code>None</code>. In addition <code>str()</code> raises UnicodeEncodeError frequently.</p>

      <p>Other solution is <a href="http://pypi.python.org/Webext/">Webext</a>. <a href="http://pypi.python.org/Webext/">Webext</a> is an extension module which implement <code>to_str()</code> and <code>escape()</code> in C language.</p>
      <pre class="program">
import tenjin
from tenjin.helpers import *
<strong>from webext import to_str, escape</strong>    # use webext's functions instead of tenjin's
</pre>

      <p>Benchmark script in Tenjin already supports Webext. It shows that Webext makes Tenjin much faster especially html escaping.</p>

      <div class="terminal_caption">
        Intel CoreDuo2 2GHz, Mac OS X 10.6, Python 2.5.5
      </div>
      <pre class="terminal">
### without html escaping
$ cd Tenjin-X.X.X/
$ cd benchmark/
$ python bench.py -q -n 10000 tenjin tenjin-str tenjin-webext
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             3.8100    0.0400    3.8500    3.8462
tenjin-str                         2.4500    0.0200    2.4700    2.4815
tenjin-webext                      2.4500    0.0300    2.4800    2.4825

## with html escaping
$ python bench.py -e -q -n 10000 tenjin tenjin-str tenjin-webext
*** ntimes=10000
                                    utime     stime     total      real
tenjin                             7.2900    0.0500    7.3400    7.4669
tenjin-str                         5.7400    0.0400    5.7800    5.8202
tenjin-webext                      2.9700    0.0400    3.0100    3.0079
</pre><br>
      <a name="tips-m17n" id="tips-m17n"></a>

      <h3 class="section2">M17N Page</h3>

      <p>If you have M17N site, you can make your site faster by Tenjin.</p>

      <p>In M17N-ed site, message translation function (such as <code>_('message-key')</code>) is called many times. Therefore if you can eliminate calling that function, your site can be faster. And Tenjin can do it by preprocessing.</p>

      <p>The point is:</p>

      <ul type="disc">
        <li>Change cache filename according to language. For example, create cache file 'file.pyhtml.en.cache', 'file.pyhtml.fr.cache', 'file.pyhtml.it.cache', and so on from a template file 'file.pyhtml'. This can be done by overriding CacheStorage#_cachename().</li>

        <li>Create CacheStorage and Engine object for each language.</li>

        <li>Enable preprocessing to create different cache content for each language.</li>
      </ul>

      <p>The following is an example to generate M17N pages from a template file.</p><a name="test_m18n/m18n.pyhtml"></a>

      <div class="program_caption">
        m18n.pyhtml:
      </div>
      <pre class="program">
&lt;div&gt;
&lt;?PY ## '_()' represents translator method ?&gt;
 &lt;p&gt;<strong>${{_('Hello')}}</strong> ${username}!&lt;/p&gt;
&lt;/div&gt;
</pre><a name="test_m18n/m18n.py"></a>

      <div class="program_caption">
        m18n.py:
      </div>
      <pre class="program">
# -*- coding: utf-8 -*-
import tenjin
from tenjin.helpers import *
import re

##
## message catalog to translate message
##
MESSAGE_CATALOG = {
    'en': { 'Hello': 'Hello',
            'Good bye': 'Good bye',
          },
    'fr': { 'Hello': 'Bonjour',
            'Good bye': 'Au revoir',
          },
}

##
## create translation function and return it.
## ex.
##    _ = create_m18n_func('fr')
##    print _('Hello')   #=&gt; 'Bonjour'
##
def create_m18n_func(lang):
    dct = MESSAGE_CATALOG.get(lang)
    if not dct:
        raise ValueError("%s: unknown lang." % lang)
    def _(message_key):
        return dct.get(message_key)
    return _
    # or return dct.get
    
##
## cache storage class to cache template object for each language
##
class M17nCacheStorage(tenjin.MarshalCacheStorage):

    lang = 'en'       # default language

    def __init__(self, *args, **kwargs):
        if 'lang' in kwargs:
            lang = kwargs.pop('lang')
            if lang: 
                self.lang = lang
        tenjin.MarshalCacheStorage.__init__(self, *args, **kwargs)

    ## change cache filename to 'file.pyhtml.lang.cache'
    <strong>def _cachename(self, fullpath):</strong>
        <strong>return "%s.%s.cache" % (fullpath, self.lang)</strong>

##
## test program
##
if __name__ == '__main__':

    ## create cache storage and engine for English
    <strong>m17ncache = M17nCacheStorage(lang='en')</strong>
    engine_en = tenjin.Engine(preprocess=True, <strong>cache=m17ncache</strong>)

    ## render html for English
    context = { 'username': 'World' }
    <strong>context['_'] = create_m18n_func('en')</strong>
    html = engine_en.render('m18n.pyhtml', context)
    print("--- lang: en ---")
    print(html)
    
    ## create cache storage and engine for French
    <strong>m17ncache = M17nCacheStorage(lang='fr')</strong>
    engine_fr = tenjin.Engine(preprocess=True, <strong>cache=m17ncache</strong>)

    ## render html for French
    context = { 'username': 'World' }
    <strong>context['_'] = create_m18n_func('fr')</strong>
    html = engine_fr.render('m18n.pyhtml', context)
    print("--- lang: fr ---")
    print(html)
</pre><a name="test_m18n/result.output"></a>

      <div class="terminal_caption">
        Result:
      </div>
      <pre class="terminal">
$ python m18n.py
--- lang: en ---
&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> World!&lt;/p&gt;
&lt;/div&gt;

--- lang: fr ---
&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> World!&lt;/p&gt;
&lt;/div&gt;

</pre>

      <p>After that, you can find two cache files are created.</p>
      <pre class="terminal">
$ ls m18n.pyhtml*
m18n.pyhtml    m18n.pyhtml.<strong>en</strong>.cache    m18n.pyhtml.<strong>fr</strong>.cache
</pre>

      <p>And each cache files have different content.</p>
      <pre class="terminal">
### "_('Hello')" is translated into "Hello" in Engilish cache file
$ pytenjin -a dump m18n.pyhtml.en.cache
_buf.extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Hello</strong> ''', escape(to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));

### "_('Hello')" is translated into "Bonjour" in French cache file
$ pytenjin -a dump m18n.pyhtml.fr.cache
_buf.extend(('''&lt;div&gt;
 &lt;p&gt;<strong>Bonjour</strong> ''', escape(to_str(username)), '''!&lt;/p&gt;
&lt;/div&gt;\n''', ));
</pre><br>
      <a name="template-inheritance" id="template-inheritance"></a>

      <h3 class="section2">Template Inheritance</h3>

      <p>Tenjin doesn't support Template Inheritance which Django template engine does. But you can emulate it by capturing<sup>(<a href="#fnref:2" name="fnlink:2" id="fnlink:2">*2</a>)</sup>. See <a href="#capturing">this section</a> for details.</p>

      <div class="footnote">
        <dl compact>
          <dt>(<a name="fnref:2" href="#fnlink:2" id="fnref:2">*2</a>)</dt>

          <dd>Notice that capturing is useful but not so powerful than template inheritance.</dd>
        </dl>
      </div><br>
      <br>
    </div>
  </blockquote>
</body>
</html>
